/*
==============================================================================*/
#include <cstdio>
#include <iostream>
#include <cassert>
#include <algorithm>
#include <utility>
#include <limits>
#include <array>
#include <chrono>
#include <cstdlib>

#include "onnx-classifier-lib.h"

const std::size_t IN_SIZE = 180,
                  OUT_SIZE = 8;

void run_test(int n, ClassifierPtr &tc, std::array<float,IN_SIZE> &input, std::array<float,OUT_SIZE> &output)
{
    for(int i=0; i<n; ++i)
    {
        auto start = std::chrono::high_resolution_clock::now();
        int result = classify(tc,input,output);
        auto stop = std::chrono::high_resolution_clock::now();

        printf("Predicted class %d confidence: %f\n", result, output[result]);
        std::cout << "It took " << std::chrono::duration_cast<std::chrono::microseconds>(stop - start).count() << "us" << std::endl;
        std::cout << "(or " << std::chrono::duration_cast<std::chrono::milliseconds>(stop - start).count() << "ms)" << std::endl;
    }
}

int main(int argc, char* argv[])
{
    if (argc != 2)
    {
        fprintf(stderr, "USAGE:\ntest-onnx-lib <onnx model path> \n");
        return 1;
    }
    const char* filename_cstr = argv[1];
    std::string filename(filename_cstr);

    ClassifierPtr tc = createClassifier(filename, true);

    // Output array
    std::array<float,OUT_SIZE> my_output_vec;
    std::array<float,IN_SIZE> my_input_vec;

    /* TEST 1
    *  True label is 5
    */
    std::cout << std::endl << "RUNNING TEST 1" << std::endl;
    my_input_vec = {3.625, 0.38514683, 0.03936079, 0.04709396, 0.06300732, 0.0711875, 0.08606392, 0.06902355, 0.02903778, 0.0039474685, 0.021854702, 0.042598873, 0.041589532, 0.029332463, 0.010893278, 0.013961084, 0.022030868, 0.01977975, 0.004090252, 0.0069653955, 0.016671652, 0.013354555, 0.014090451, 0.014291259, 0.011051322, 0.010158594, 0.0064223595, 0.01248467, 0.011458533, 0.009994284, 0.013238787, 0.017661477, 0.016044218, 0.013828527, 0.013603333, 0.010527938, 0.008521288, 0.00873653, 0.007344462, 0.009404727, 0.011481316, 0.011143544, 0.009568381, 0.011080972, 0.01317353, 0.01572781, 0.013522674, 0.007711665, 0.006461839, 0.007136383, 0.010647221, 0.021637155, 0.390763, 0.29611233, 0.19243722, 0.11415137, 0.019232243, 0.009984808, 0.0044673365, -0.041266687, -0.03883738, -0.02029248, -0.12185976, -0.12159027, -0.10020457, -0.12884602, -0.046047255, -0.05814432, 0.04542908, 0.073154286, 0.1260658, -0.033411175, -0.049457848, -0.014473713, -0.0022794167, -0.00501319, -0.043063592, -0.025112964, 0.027518861, -0.0015028166, 0.00055111013, 0.01124324, 0.0064527006, -0.008123033, 0.0057102377, 0.018662587, 0.01498382, 0.009124798, 0.005164029, -1.923497, 0.54915655, 0.3156318, 0.06771977, 0.27012712, 0.07368505, -0.008586774, 0.12282617, 0.034527615, 0.06806106, 0.053466063, 0.14967827, 0.02512157, 0.055795833, 0.0016999285, 0.024474269, 0.001027368, 0.03126403, 0.027659904, -0.004404274, 0.03730075, -0.014162515, 0.037825793, 0.032451898, 0.016462449, -0.0015582639, 0.03739834, -0.019242026, 0.041142702, -0.011109289, -0.0027495995, 0.012508907, -0.012435865, -0.0019113577, -0.018282467, -0.015505125, 0.015850997, 0.012455502, -0.036040552, -0.011963067, 0.02407597, -0.012363088, 0.015199204, -0.008752793, 0.028822705, -0.02155123, 0.007467055, -0.020157624, -0.0044838055, -0.009900575, 0.00943007, -0.011730059, 0.028252002, -0.023630911, 0.005380597, -0.021692773, -0.008632546, -0.0039900467, 1.0000004, 0.4180236, 0.30081168, 0.1854852, 0.12308019, 0.008659558, -0.045006115, -0.054887246, -0.058669575, -0.13274688, -0.05635027, -0.080968894, -0.04680723, -0.12637651, -0.08654976, -0.14382623, -0.10396543, -0.10735747, -0.07773444, -0.05504489, -0.02648174, 0.008542597, 0.08072735, 0.10672531, 0.12868975, 0.10189716, -0.036518805, -0.024741003, -0.0023631756, 0.01432192, 0.003987397, 0.24659348, 15.0};
    run_test(4, tc, my_input_vec, my_output_vec);

    /* TEST 2
    *  True label is 1
    */
    std::cout << std::endl << "RUNNING TEST 2" << std::endl;
    my_input_vec = {1.5208334, 0.55579937, 0.044158317, 0.054159608, 0.06791343, 0.07166596, 0.05390836, 0.023068313, 0.00052320067, 0.0068622394, 0.0029857487, 0.0032741176, 0.005410005, 0.01196877, 0.016669508, 0.011512609, 0.01230337, 0.023755515, 0.034061678, 0.03253104, 0.03773725, 0.021868827, 0.037735652, 0.05059612, 0.018555056, 0.004588107, 0.0053057675, 0.013933268, 0.012112969, 0.029371466, 0.021786071, 0.013178172, 0.01431354, 0.015713813, 0.013418889, 0.012844548, 0.013924948, 0.01762218, 0.020163307, 0.012762479, 0.013939545, 0.018550359, 0.018703831, 0.015194244, 0.015457474, 0.01565103, 0.014653913, 0.007930131, 0.005902792, 0.004377152, 0.0026978736, 0.0026775294, 0.25557867, 0.044029564, 0.14170015, 0.15238284, 0.31255704, 0.174793, 0.09538316, -0.053420804, -0.029426515, 0.015975008, -0.021128628, -0.1285218, -0.038479835, -0.06683645, -0.11620895, -0.07421066, 0.015343076, 0.013028649, -0.050086077, 0.03951694, 0.039943393, -0.02360104, 0.006567242, 0.047538746, 0.003780008, -0.03974654, -0.030600276, -0.037682462, 0.003060698, 0.022301225, 0.012548858, -0.008590497, 0.008663112, 0.025261767, 0.0015105444, -0.03122769, 0.012947773, -4.601057, 0.974621, 0.029153004, 0.09610685, 0.22519597, -0.038654637, 0.11295915, 0.023000132, 0.08910764, -0.014388653, 0.037921783, 0.037389427, -0.06940743, 0.078119494, -0.028326802, 0.039187152, -0.07394462, -0.015766805, -0.07356329, -0.011594859, -0.015183094, 0.023015246, -0.0033176322, -0.039256938, 0.039258115, 0.037889984, 0.024234066, 0.10820676, 0.049332783, 0.041084666, 0.11316781, 0.07314482, -0.021397762, 0.046051633, -0.008539219, 0.06473773, 0.00060760166, 0.012546962, 0.0061037475, 0.08026824, 0.028421622, -0.034529623, 0.036452033, 0.08791695, 0.073101625, 0.0043017366, 0.043988008, -0.021757156, 0.0013185686, -0.061153777, 0.045324735, 0.10980364, -0.065930314, 0.028464714, -0.05683028, -0.013156317, 0.023701888, 0.03210621, 0.9999999, 0.30903906, 0.02216794, 0.06479327, 0.01923529, 0.20586817, 0.19545399, 0.18324205, 0.049561784, -0.083768986, -0.10960867, -0.04996009, 0.014593756, -0.065656774, -0.14945264, -0.13900581, -0.07412952, -0.072903015, -0.09025848, -0.09441451, -0.024059512, 0.057929836, 0.023520967, -0.009856171, -0.010455855, -0.020053964, -0.03477248, 0.01711723, 0.041868493, 0.01770085, -0.007027814, 0.02322793, 58.0};
    run_test(4, tc, my_input_vec, my_output_vec);

    /* TEST 3
    *  True label is 7
    */
    std::cout << std::endl << "RUNNING TEST 3" << std::endl;
    my_input_vec = {4.6666665, 0.48641965, 0.044747245, 0.055742778, 0.068042226, 0.06934613, 0.027815342, 0.026367202, 0.04055702, 0.024267929, 0.010924947, 0.02669055, 0.02616099, 0.02245269, 0.02498261, 0.007213174, 0.00818206, 0.019788412, 0.010299083, 0.027259614, 0.032912515, 0.019062955, 0.012624065, 0.010253381, 0.010926787, 0.022440026, 0.021034507, 0.01550635, 0.012439054, 0.017378042, 0.03549384, 0.02265917, 0.010733142, 0.011535512, 0.012122616, 0.018646235, 0.014761471, 0.013568825, 0.0120917, 0.012469684, 0.012805777, 0.01278146, 0.012781107, 0.010839098, 0.012787358, 0.013437714, 0.009765922, 0.009673664, 0.007875542, 0.006072493, 0.0060301987, 0.0056498107, 0.3181927, 0.12883277, 0.19205675, 0.12627853, 0.0964493, 0.047672085, 0.06759444, -0.0030772877, -0.010207876, 0.022936862, 0.042481564, -0.026495252, -0.06817542, -0.066660225, -0.026459292, 0.03239644, -0.010170072, -0.10709141, -0.05559466, -0.031502575, -0.010118201, -0.014840248, 0.019166552, 0.048970953, 0.019979626, 0.021213943, 0.018104114, -0.0072712693, -0.054486163, 0.0047723707, 0.020624382, -0.013788396, -0.000930656, -0.025934609, -0.020822464, -0.0009815446, -0.011424952, -2.792422, 0.85632515, 0.16561049, 0.18502541, 0.1395152, 0.061900195, 0.060637433, 0.06839221, 0.02378262, 0.070508495, 0.025994036, 0.041449543, 0.046903417, 0.013048813, 0.02888451, 0.06054393, 0.022524351, 0.055439524, -0.026035126, 0.013982396, 0.025975948, -0.05853482, 0.002726597, 0.038006574, -0.0067829797, 0.060906563, 0.021646127, 0.018631443, 0.030359661, 0.0022260426, -0.001115654, 0.010237506, -0.062431674, -0.013500826, 0.050497137, 0.033555437, -0.007908377, -0.019133965, 0.072491676, 0.020675201, -0.044021796, -0.01076544, -0.03151625, -0.040236183, -0.067802615, -0.03973732, -0.011993878, 0.0032303524, -0.040629823, -0.02932695, 0.026892863, 0.021203876, -0.02835133, -0.017612914, -0.040395826, -0.029427603, -0.014559845, -0.0268926, 0.9999999, 0.36612543, 0.10955413, 0.13527986, 0.08986596, 0.07131145, -0.0037652124, 0.015455635, -0.0005598571, -0.04175765, -0.07426287, -0.041310444, 0.032947764, 0.030369107, -0.019816374, -0.0472591, -0.070667334, -0.11956556, -0.08696267, 0.018555775, 0.029858638, -0.050236125, -0.06614797, -0.018006762, -0.0024716542, -0.023082934, 0.029097395, 0.058763985, 0.05521041, 0.047753062, 0.046987005, 0.13480961, 22.0};
    run_test(4, tc, my_input_vec, my_output_vec);

    deleteClassifier(tc);

    return 0;
}